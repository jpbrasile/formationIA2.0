# FormationIA2.0

<details>
<summary><b>Qu'est-ce que l'IA peut vous rapporter ?</b></summary>
<p>Ce document est intéressant car il explore l'impact réel des Modèles de Langage à Grande Échelle (LLM), comme GPT-4, sur des tâches complexes et riches en connaissances. L'étude, menée avec le Boston Consulting Group, impliquait 758 consultants et visait à comprendre comment l'IA peut améliorer la performance humaine dans un contexte professionnel.</p>
<p>Principales conclusions de l'étude :</p>
<ul>
    <li><strong>Productivité et Qualité Accrues</strong> : Les consultants utilisant l'IA étaient nettement plus productifs et produisaient un travail de meilleure qualité. En moyenne, ils ont complété 12,2 % de tâches en plus et ce, 25,1 % plus rapidement. De plus, la qualité de leur travail était supérieure de plus de 40 % par rapport à ceux n'utilisant pas l'IA.</li>
    <li><strong>Bénéfices à Tous les Niveaux de Compétences</strong> : L'étude a révélé que l'augmentation par l'IA profitait significativement aux consultants à tous les niveaux de compétence. Ceux en dessous du seuil de performance moyen ont vu leur performance augmenter de 43 %, tandis que ceux au-dessus ont amélioré de 17 %.</li>
    <li><strong>Limites de l'IA</strong> : L'étude a également identifié des tâches actuellement hors de portée de l'IA. Pour ces tâches, les consultants utilisant l'IA étaient 19 points de pourcentage moins susceptibles de produire des solutions correctes par rapport à ceux sans accès à l'IA.</li>
    <li><strong>Modèles d'Intégration de l'IA</strong> : L'étude a observé deux modèles distincts dans la façon dont les consultants intégraient l'IA dans leur travail :
        <ul>
            <li><strong>Centaures</strong> : Certains consultants agissaient comme des Centaures, divisant les tâches entre eux et l'IA, déléguant certaines activités à l'IA.</li>
            <li><strong>Cyborgs</strong> : D'autres agissaient plus comme des Cyborgs, intégrant complètement leur flux de travail avec l'IA et interagissant continuellement avec elle.</li>
        </ul>
    </li>
</ul>
<p>Pour plus de détails, consultez le document complet : <a href="https://www.hbs.edu/ris/Publication%20Files/24-013_d9b45b68-9e74-42d6-a1c6-c72fb70c7282.pdf">Lien vers l'étude</a>.</p>
</details>


<details>
  <summary> <b>Les astuces à utiliser</b></summary>
  <br> 
  <details>
    <summary> Impression d'écran sous windows?</summary>
   
    Touche Windows+MAj+S
  </details>
  <details>
    <summary> Insérer l'image dans GitHub</summary>

    Télécharger l'image puis simple upload au point de la page wiki où l'on veut mettre l'image
  </details>
  <details>
    <summary> Pour obtenir de chatGPT un format markdown à couper/coller </summary>
  
    "Fournis le contenu formaté en Markdown, présenté sous forme de chaîne de caractères " 
  </details>


   <details>
    <summary>accéder à toutes les commandes d'Harpa </summary>

   il suffit de mettre "/" dans le chat; ex: "/clear": supprime l'historique des chats.
  </details>
</details>
  
</details>


## Formation à l'IA en 2024: 

Dans le tableau ci-après: 3 niveaux de formation : Débutant, intermédiaire et avancé
- **Quels outils ?** : Ceux à maîtriser pour être efficace:  Halte aux problèmes ! Euh non !  "**Alt A <Problème>!**" et Harpa.ai vous répondra !
- **Le prompt** : Comment parler avec le chatbot pour que sa réponse soit pertinente ?
- **Fournir aux LLM nos propres données** : Comment le chatbot peut prendre en compte mes données ?
- **Accès à Internet**: Comment faire pour qu'il prenne les données pertinantes sur le cloud ?
- **Gérer le Contexte**: Comment composer avec sa mémoire vive qui ne peut accumuler qu'un nombre fini de données ?
- **Au delà de l'écrit** : Comment travailler avec des données non textuelles (images, son ... ) tant en entrée qu'en sortie ?
- **L'accès aux outils externes**: Comment faire que le chatbot accède à des ressources externes disponibles sur le web ?
- **Chatbots spécialisés** : Comment créer des chatbots spécialisés pour remplir certaines tâches ?
- **Travail en équipe**: Comment créer des chatbots travaillant en équipe
- **L'IA apprend toute seule** : Comment faire pour que les Chatbot apprennent de leurs erreurs ?

| Niveau        | Objectif                              | [Quels outils  ?](https://github.com/jpbrasile/formationIA2.0/wiki/Installation-des-outils.md)                           | [Le prompt](https://github.com/jpbrasile/formationIA2.0/wiki/4.-Le-prompting)                                           | [Fournir aux LLM nos propres données](https://github.com/jpbrasile/formationIA2.0/wiki/6.-Fournir-aux-LLM-nos-propres-donn%C3%A9es)                                               | [L'Accès à Internet](https://github.com/jpbrasile/formationIA2.0/wiki/L'acc%C3%A8s-%C3%A0-internet.md)                                            | [Gérer le contexte](https://github.com/jpbrasile/formationIA2.0/wiki/5.-Gestion-du-contexte)                                             | [Au delà de l'écrit](https://github.com/jpbrasile/formationIA2.0/wiki/9.-Les-LLM-multimodaux-(MLLM))                                         | [L'accès aux outils externes](https://github.com/jpbrasile/formationIA2.0/wiki/8.-L%E2%80%99Acc%C3%A8s-aux-API)                                               | [Chatbots spécialisés](https://github.com/jpbrasile/formationIA2.0/wiki/A.-Les-GPTs)                                              | [Travail en équipe](https://github.com/jpbrasile/formationIA2.0/wiki/B.-Les-agents)                                           | [L'IA apprend toute seule](https://github.com/jpbrasile/formationIA2.0/wiki/C.-L%E2%80%99apprentissage-par-renforcement-:)                                               |
|---------------|---------------------------------------|-----------------------------------------|------------------------------------------------------|------------------------------------------------------|-----------------------------------------------------|----------------------------------------------------|---------------------------------------------------|----------------------------------------------------|----------------------------------------------------|----------------------------------------------------|----------------------------------------------------|
| Débutant      | [Utiliser l'IA, ](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20pour%20d%C3%A9butants/1-%20prendre%20des%20notes.md) [challenge](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20pour%20d%C3%A9butants/challenge.md)       | [Nos outils:](https://github.com/jpbrasile/formationIA2.0/wiki/01:-Comment-disposer-d'outils-qui-font-tout-pour-vous-%3F)  [ChatGPT](https://chat.openai.com/), [Copilot](https://copilot.microsoft.com/?culture=fr-fr&country=fr), [Harpa](https://harpa.ai/), [Perplexity](https://www.perplexity.ai/), [Canva](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20pour%20d%C3%A9butants/canva.md)           [ GitHub, ](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/github.md) [Capcut](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20pour%20d%C3%A9butants/capcut.md)  | [Les bases](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20pour%20d%C3%A9butants/3-%20le%20prompting.md) |Avec nos outils       | Avec nos outils              |  Un prompt pour demander la synthèse   | Copilot (dessin) et [outils en ligne, ](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20pour%20d%C3%A9butants/multimodal.md)| [Runway](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20pour%20d%C3%A9butants/Runway.md) [Outils en ligne](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20pour%20d%C3%A9butants/5-%20API.md)          |  |                |
| Intermédiaire | [Maîtriser l'IA, ](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/choisir%20son%20IA.md)  [DeepLearning courses](https://www.deeplearning.ai/short-courses/)        | [Quel LLM ? ](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/WhatLLM.md) [MixtralReplicate, ](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/Replicate.md)    (MistralMédium](https://jeanviet.fr/mistral-medium/)        | [MetricMule et Formation](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/le%20prompting.md)    |[Pinecone,](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/RAG.md) [voiceflow,](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/VoiceFlow.md)[Haystack](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/choisir%20son%20IA.md) | [GPT Crawler,](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/scraping.md) [GPT-Researcher, ](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/GPt-Researcher.md) [OnLine Shop](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/OnLineShop.md)                   | [MEMGPT,...](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/context.md)             | [ComfyUI,LLAVA,](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/multimodal.md) [firellava](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/firellava.md) [Local ChatGPT, ](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/Local%20ChatGPT.md) [WhisperSpeech, ](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/WhisperSpeech.md) [fuyu](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/fuyu.md)| [Langchain,...](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/API.md) , [Colab, HF...](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/choisir%20son%20IA.md)   ,[open interpreter](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/Open%20Interpreter.md) [Phind, ](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/Phind.md) [wolfram, ](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/programWithWolfram.md) [taskweaver, ](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/taskweaver.md) [AIDER, ](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/AIDER.md) [CURSOR](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/CURSOR.md)    | [emploi des GPTs openAI,](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/GPTs.md) [voiceflow](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/VoiceFlow.md)       |     [AutoGen, CrewAI, ](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/Agent.md) [n8n](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20interm%C3%A9diaire/n8n.md)       |   |
| Avancé        | [Créer avec l'IA](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20avanc%C3%A9/challenges.md),[aller plus loin](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20avanc%C3%A9/Apprendre%20l'IA%20en%202024.md)       |[+vite](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20avanc%C3%A9/Etat%20de%20l'art.md),[>GPT4](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20avanc%C3%A9/Quel%20LLM.md) [Finetuning,Quantification...](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20avanc%C3%A9/les%20outils.md) Création de MOE | [Prompt optimisé par programmation](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20avanc%C3%A9/prompting.md)                   | Création de base de données locales       | AgentSearch et Wiki search | Gestion avancée du contexte (compactage)                        | [animation 3D, audiobook...](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20avanc%C3%A9/multimodal.md) | Conception d'API robustes pour des applications à grande échelle | [Screen2Code, ](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20avanc%C3%A9/GPTs.md) [Crack](https://github.com/jpbrasile/formationIA2.0/blob/main/cours%20avanc%C3%A9/Crack.md)    | Développement d'agents autonomes capables d'apprentissage continu | Stratégies pour le développement de talents en IA et gestion des changements technologiques |

## ChatGPT C'est quoi ? : 
- [00:00](https://www.youtube.com/watch?v=PNjh4z8WF9M&t=0s) 🤖 Qu'est-ce que ChatGPT ? [Large Language Model Base: un LLM à la maternelle](https://github.com/jpbrasile/formationIA2.0/wiki/1.-LLM%E2%80%90Base) 

  - ChatGPT est une machine à approximer qui fournit des réponses basées sur ce qu'il a appris.
  - Il est efficace pour interpoler mais peut fournir de fausses réponses en l'absence de données suffisantes.
  - L'apprentissage de ChatGPT nécessite l'ajustement de ses paramètres en fonction des données d'entrée, et il a utilisé des milliards de données pour ajuster ses paramètres.

- [01:11](https://www.youtube.com/watch?v=PNjh4z8WF9M&t=71s) 📚 Comment instruire ChatGPT ? : [Le LLM à l'école](https://github.com/jpbrasile/formationIA2.0/wiki/2.-LLM%E2%80%90Instruct) 
  - Pour instruire ChatGPT, il faut lui donner des directives sur son comportement.
  - Alimenter la machine avec une nouvelle base de données de type question-réponse lui permet de mimer ce type de résultat.
  - Des gardes-fous sont nécessaires pour censurer certaines réponses et inculquer les bonnes manières.

- [02:09](https://www.youtube.com/watch?v=PNjh4z8WF9M&t=129s) 💻 Implantation de ChatGPT

  - ChatGPT est principalement disponible en ligne via le Cloud, en raison de son coût de développement.
  - Le contrôle sur l'utilisation de ChatGPT est difficile, ce qui soulève des préoccupations concernant la divulgation d'informations sensibles.
  - Un mouvement open source travaille sur des versions plus légères de ChatGPT pour des utilisations locales.

- [03:18](https://www.youtube.com/watch?v=PNjh4z8WF9M&t=198s) 🧠 La taille et le contexte des LLM : [Le LLM peut soutenir une conversation](https://github.com/jpbrasile/formationIA2.0/wiki/3.-LLM%E2%80%90Chat) 

  - Les LLM (Large Language Models) sont en constante évolution pour devenir plus légers tout en maintenant leur performance.
  - La taille des LLM est mesurée en milliards de bytes, et des versions plus compactes sont développées.
  - Le contexte, ou mémoire à court terme, est crucial pour stocker des informations pertinentes lors de l'interaction avec un LLM.
 
  ## L'open-source proche de GPT4
  ![Capture d'écran 2024-01-24 155607](https://github.com/jpbrasile/formationIA2.0/assets/8331027/0ef1137e-e79c-405d-8816-cad6a82e41b6)

  ## Un stack local ou déployable sur hostinger domaine: atthesametime.eu
  -  fait à partir de [Colin](https://github.com/coleam00/local-ai-packaged)
  -  url:
      - n8N:    http://localhost:5678/
      - flowise: http://localhost:3001/
      - Searxng: http://localhost:8080/
      - openrouter: https://openrouter.ai/
      - openwebui: http://localhost:3000/
      - qdrant: http://localhost:6333/
      - caddy avec
          -  N8N_HOSTNAME=${N8N_HOSTNAME:-":8001"}
          - WEBUI_HOSTNAME=${WEBUI_HOSTNAME:-":8002"}
          - FLOWISE_HOSTNAME=${FLOWISE_HOSTNAME:-":8003"}
          - OLLAMA_HOSTNAME=${OLLAMA_HOSTNAME:-":8004"}
          - SUPABASE_HOSTNAME=${SUPABASE_HOSTNAME:-":8005"}
          - SEARXNG_HOSTNAME=${SEARXNG_HOSTNAME:-":8006"}
          - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-internal}
        - ollama: http://localhost:11434
- Hostinger : systeme d'exploitation avec docker (application)
 # Configuration complète pour LocalAI Stack sur VM

## 1. Installation de Docker
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y git curl
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER
# Déconnectez-vous et reconnectez-vous pour appliquer les changements
```

## 2. Configuration de la mémoire swap
```bash
# Créer un fichier swap de 8GB
sudo fallocate -l 8G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
# Rendre le swap permanent
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

## 3. Configuration du pare-feu UFW pour Docker
```bash
# Permettre le trafic sur l'interface docker0
sudo ufw allow in on docker0
sudo ufw allow out on docker0

# Permettre le trafic depuis le sous-réseau Docker
sudo ufw allow from 172.17.0.0/16
sudo ufw route allow in on docker0
sudo ufw route allow out on docker0

# Autoriser les ports nécessaires
sudo ufw allow 11434/tcp  # Pour Ollama
sudo ufw allow 3000/tcp   # Pour OpenWebUI
sudo ufw allow 3001/tcp   # Pour Flowise
sudo ufw allow 5678/tcp   # Pour n8n
sudo ufw allow 8080/tcp   # Pour SearxNG
sudo ufw allow 6333/tcp   # Pour Qdrant

# Recharger UFW
sudo ufw reload
```

## 4. Configuration de Docker Compose
Assurez-vous d'ajouter `extra_hosts` à tous les services qui doivent communiquer avec d'autres services :

```yaml
services:
  votre-service:
    # ...autres configurations...
    extra_hosts:
      - "host.docker.internal:host-gateway"
```

Ou mieux, utilisez les noms de services directement (par exemple `http://ollama:11434`) puisque les conteneurs sont sur le même réseau Docker.

## 5. Choix du modèle adapté aux ressources
Pour les VMs avec moins de 8GB de RAM :
```bash
docker exec -it ollama ollama pull phi3:mini
# ou
docker exec -it ollama ollama pull mistral:instruct
```

## Points importants à retenir
- Le pare-feu UFW et Docker ont des interactions complexes qui nécessitent une configuration spécifique
- Utilisez les noms de services pour la communication entre conteneurs sur le même réseau
- Adaptez les modèles LLM à vos ressources matérielles disponibles
- Vérifiez les connexions avec `curl` pour diagnostiquer les problèmes

Cette configuration devrait résoudre les problèmes de communication entre Docker et le système hôte, ainsi que les limitations de mémoire pour les modèles LLM.


- http://host.docker.internal:11434/ --> ollama   // https://ollama.atthesametime.eu/
- http://host.docker.internal:6333/ -->  qdrant  //http://localhost:6333/  --> curl http://localhost:6333  dans hostinger
- https://searxng.atthesametime.eu/   http://localhost:8080/
- https://flowise.atthesametime.eu/   http://localhost:3001/
- https://supabase.atthesametime.eu/   http://localhost:8000 (via kong)
- https://openwebui.atthesametime.eu/      http://localhost:3000/
- https://n8n.atthesametime.eu/    http://localhost:5678/home/workflows

## IA Comment suivre le rythme ?
- Tout va très vite et pour ma^triser l'IA et ne pas être seulement spectateur il faut une méthode, je propse le couper/coller
- Un acteur [Cole Melin](https://www.youtube.com/@ColeMedin) sur youtube, (créateur de bolt) travaille à temps plein pour apporter sur la base de 2 vidéos par semaine le résultat de son travail. Il vise à trouver des soutions généralements open source, et il est complètement transparent sur ces propres travaux que l'on peut dupliquer .
- Ce travail de couper/coller demande néanmoins des efforts, mais c'est la meilleure façon d'apprendre à apprendre , en étant acteur.
- J'ai ainsi dupliquer , temps en local que sur Hostinger avec mon domaine atthesametime.eu un stack qui correspond à l'état de l'art actuel avec
    - n8n : on peut automaiser près de 500 tâches , elles sont accessibles via des nodes webhooks qui fournissent les url d'accès et en créant les crédentials requis
    - flowise: qui en nos code permet de créer des agents
    - openwebui : qui permet d'interagir avec notre stack en no code aavec un interface rsssemblant à celui de chatGPT
    - searxng pour les recherches sur le net
    - supabase et GDrant pour base de données
    - ollama pour les llm locaux.J'utilise aussi openrouter pour des llm plus performants (certains sont gratuits comme mistralai/mistral-small-3.1-24b-instruct:free 
    - caddy pour le cryptage
 
- Le portage sur Hostinger avec une configuration CPU 2 cores 8GB, 100GB ne coûte que ~ 6 € /mois et permet de partager le stack sur un réseau délocalisé    

### Synthèse : Création de l'utilisateur avec les droits Docker
- Création de l'utilisateur jpb :
L'utilisateur jpb a été créé avec la commande suivante :
```
sudo adduser jpb
```
- Cette commande a permis de créer un utilisateur avec un répertoire personnel et de définir un mot de passe.
- mais cela à planté le terminal d'où un reset du SSH et un redémarrage de la VDS pour débloqier. 
- Ajout de jpb au groupe Docker :
    - Pour permettre à jpb d'exécuter des commandes Docker sans utiliser sudo, il a été ajouté au groupe docker :
```
sudo usermod -aG docker jpb
```
    	- Cette commande associe l'utilisateur jpb au groupe docker, qui dispose des permissions nécessaires pour gérer Docker.
- Application des modifications :
    - Après avoir ajouté jpb au groupe docker, il a été nécessaire de se reconnecter en tant que jpb pour appliquer les changements :
```
su - jpb
``` 

- Cela a permis à l'utilisateur jpb de bénéficier des droits Docker sans redémarrer le système.
- Vérification des droits Docker :
    - Pour confirmer que jpb pouvait exécuter des commandes Docker, la commande suivante a été testée :
```
docker ps
```
    - Si cette commande a affiché les conteneurs en cours d'exécution sans erreur, cela a confirmé que les droits Docker étaient correctement configurés.
- Problème des applications Docker demandant un email et un mot de passe :
    - Bien que jpb ait obtenu les droits Docker, certaines applications Docker nécessitaient une configuration supplémentaire (email et mot de passe). Cela a été identifié comme une étape distincte à configurer pour chaque application.


## Step-by-step process to properly reset and restart your environment:

- First, check what's currently running:
```
docker ps
```
- Stop all services completely, including Supabase:
```
docker compose -p localai -f docker-compose.yml -f supabase/docker/docker-compose.yml down
```
- Remove any orphaned containers:
```
docker container prune -f
```
- Clean up networks (optional, but helpful if networking issues persist):
```
docker network prune -f
```
- Pull the latest versions of all containers:
```
docker compose -p localai -f docker-compose.yml -f supabase/docker/docker-compose.yml pull
```
- Start services again using the start_services.py script:

```
python start_services.py --profile cpu  # ou gpu-nvidia 
```

- This comprehensive approach should:

    - Remove all conflicting containers
    - Clean up network configurations
    - Update to latest container versions
    - Start everything fresh without conflicts
    - The key was including both the LocalAI and Supabase configurations when stopping and pulling, as your error messages showed conflicts between these environments.


## Guide pour ajouter un nouvel utilisateur à n8n
- Prérequis
    -  Accès SSH au serveur n8n (Hostinger)
    - Clé API n8n valide (obtenue par l'administrateur)
    - PowerShell ou terminal sur votre machine locale
- Étape préliminaire: Obtenir la clé API (Admin uniquement)
    - L'administrateur doit se connecter à https://n8n.atthesametime.eu
    - Aller dans Paramètres > API n8n
    - Cliquer sur Créer une clé API
    - Copier la clé générée pour l'utiliser dans les commandes
- Étape 0: Ouvrir le port SSH (si nécessaire)
    - Si le port SSH (22) n'est pas ouvert, connectez-vous au terminal Hostinger en tant que root et exécutez:

```
# Autoriser le port SSH dans le pare-feu UFW
sudo ufw allow 22/tcp
sudo ufw reload

# Vérifier que la règle a été ajoutée
sudo ufw status
```

- Étape 1: Créer l'utilisateur via l'API
```
# Sur le serveur n8n
curl -X POST "https://n8n.atthesametime.eu/api/v1/users" \
-H "Content-Type: application/json" \
-H "X-N8N-API-KEY: VOTRE_CLE_API" \
-d '[{
  "email": "email@exemple.com",
  "firstName": "Prénom",
  "lastName": "Nom",
  "role": "global:member"
}]'
```
- Étape 2: Récupérer le lien d'invitation
    - Dans la réponse, notez:

        - L'ID de l'utilisateur invité (inviteeId)
        - L'ID de l'invitant (inviterId)
        - Le lien d'invitation complet
- Étape 3: Configurer le tunnel SSH
```
# Sur votre machine locale
ssh -L 5679:localhost:5678 root@93.127.203.205
```
- Étape 4: Accéder au lien d'invitation
    - Ouvrez votre navigateur et accédez à:
https://n8n.atthesametime.eu/signup?inviterId=ID_INVITANT&inviteeId=ID_INVITE

- Étape 5: Finaliser l'inscription
L'utilisateur peut maintenant:

    - Définir son mot de passe
    - Accepter les conditions d'utilisation
    - Accéder à n8n

## Overview de l'Environnement Local Supabase pour Débutants

L'objectif de cette vue d'ensemble est de clarifier le rôle des différents composants que vous rencontrez lors de l'utilisation de Supabase en local, notamment après le processus de débogage que nous avons suivi.

### La Grande Image : Votre "Mini-Cloud" Local

Pensez à votre configuration Supabase locale comme à un petit "cloud" privé fonctionnant entièrement sur votre ordinateur grâce à Docker. Chaque service essentiel (base de données, authentification, etc.) est un "département" isolé mais connecté.

### Les Composants Clés et Leurs Rôles

1.  **Docker : La Fondation**
    *   **Rôle :** C'est la technologie qui permet d'exécuter chaque service Supabase (Base de données, Auth, Studio...) dans des environnements isolés appelés **conteneurs**.
    *   **Comment ça marche :** Docker utilise des "images" (des plans) pour créer ces conteneurs. `docker ps` vous montre les conteneurs en cours d'exécution.
    *   **Docker Compose (indirectement) :** Bien que vous ne le gériez pas toujours directement avec la CLI Supabase, Docker Compose est souvent utilisé en arrière-plan (ou dans les configurations self-hosted) pour définir *quels* conteneurs lancer et comment les connecter.

2.  **Supabase CLI (`npx supabase ...`) : Le Chef d'Orchestre**
    *   **Rôle :** C'est l'**outil en ligne de commande** installé sur votre machine (ou exécuté via `npx`) qui vous permet de **gérer** votre environnement Supabase local.
    *   **Fonctions :**
        *   `npx supabase start` : Lit la configuration (`supabase/config.toml`) et demande à Docker de démarrer tous les conteneurs nécessaires.
        *   `npx supabase stop` : Demande à Docker d'arrêter les conteneurs.
        *   `npx supabase status` : Affiche l'état des services.
        *   `npx supabase logs ...` : Affiche les journaux d'un service spécifique.
        *   Gère les migrations de base de données, etc.
    *   **Important :** La CLI n'est *pas* dans Docker, elle tourne sur votre PC et *pilote* Docker.

3.  **Kong : Le Gardien d'Entrée (API Gateway)**
    *   **Rôle :** C'est un conteneur qui se place **devant** tous les autres services Supabase. Toutes les requêtes venant de l'extérieur (votre navigateur, votre application) passent d'abord par Kong.
    *   **Fonctions :**
        *   **Routage :** Dirige les requêtes vers le bon service interne (ex: `/auth/v1/...` vers GoTrue, `/rest/v1/...` vers PostgREST, l'accès à Studio vers le conteneur Studio).
        *   **Sécurité (pour Studio) :** Ajoute une couche d'authentification "basique" (la pop-up demandant `DASHBOARD_USERNAME` / `DASHBOARD_PASSWORD`) pour protéger l'accès à Supabase Studio.
        *   Expose les services sur des ports spécifiques de votre machine (ex: `54321` pour l'API, `54323` pour Studio dans votre config actuelle).

4.  **Supabase Studio : Le Tableau de Bord Administrateur**
    *   **Rôle :** C'est l'**interface web** (accessible via Kong à `http://127.0.0.1:54323`) conçue pour **VOUS, le développeur/administrateur**.
    *   **Fonctions :** Permet de voir/modifier la base de données, gérer les utilisateurs (créer, inviter, supprimer), voir les logs, configurer les politiques RLS, etc.
    *   **Authentification :** L'accès est protégé par Kong (`DASHBOARD_USERNAME`/`PASSWORD`), *pas* par les identifiants des utilisateurs finaux.

5.  **Supabase Auth (GoTrue) : Le Service d'Identité Utilisateur**
    *   **Rôle :** C'est le service (un conteneur Docker) qui gère l'authentification de vos **utilisateurs finaux** (ceux qui utiliseront votre application).
    *   **Fonctions :** Gère l'enregistrement (`signUp`), la connexion (`signInWithPassword`), la déconnexion, les réinitialisations de mot de passe, les liens magiques, les connexions OAuth, la gestion des sessions (JWT).
    *   **Accès :** Il est accessible via l'API publique exposée par Kong (généralement sur le chemin `/auth/v1/...` via le port API principal, ex: `http://127.0.0.1:54321/auth/v1/token`).

6.  **Inbucket (supabase-mail) : Le Simulateur d'Email Local**
    *   **Rôle :** Intercepte tous les emails que Supabase Auth essaie d'envoyer (confirmation, invitation, reset mdp) en local.
    *   **Accès :** Fournit une interface web (`http://127.0.0.1:54324`) pour voir ces emails sans qu'ils ne soient réellement envoyés sur Internet. Essentiel pour le développement.

### Pourquoi Connecter Supabase à un Utilisateur Frontend ? L'Intérêt

Le but principal de Supabase est de vous fournir un backend complet (base de données, authentification, stockage...) pour construire des applications modernes. Voici pourquoi connecter votre frontend à Supabase pour vos utilisateurs est puissant :

1.  **Authentification Sécurisée :** Permet aux utilisateurs de créer des comptes et de se connecter de manière sécurisée à votre application. Supabase gère la complexité des mots de passe, des sessions (via JWT), etc.
2.  **Données Personnalisées (Stateful) :** Chaque utilisateur connecté peut avoir accès à **ses propres données**.
    *   **Comment :** Votre frontend utilise la `ANON_KEY` (publique) pour identifier le projet et le **JWT** (reçu après connexion, secret et spécifique à l'utilisateur) pour s'authentifier.
    *   **Sécurité Cruciale (RLS) :** Les **Politiques de Sécurité au Niveau des Lignes (RLS)**, définies dans la base de données, garantissent qu'un utilisateur authentifié ne peut accéder qu'aux données auxquelles il est autorisé (ex: voir uniquement ses propres documents, son profil, etc.). La `ANON_KEY` seule ne donne accès qu'à ce qui est explicitement autorisé pour les anonymes par les RLS.
3.  **Expérience Utilisateur Cohérente :** Les données étant stockées dans la base Supabase, l'utilisateur retrouve son environnement, ses préférences, ses fichiers, etc., à chaque connexion, sur n'importe quel appareil.
4.  **Fonctionnalités Riches :** Au-delà de la simple base de données, Supabase offre :
    *   **Realtime :** Pour des mises à jour en temps réel dans votre application (notifications, chats...).
    *   **Storage :** Pour gérer les fichiers uploadés par les utilisateurs (avatars, documents...).
    *   **Edge Functions :** Pour exécuter du code côté serveur sans gérer de serveur.

**En bref :** Connecter votre frontend à Supabase via l'API et l'authentification utilisateur vous permet de passer rapidement de l'idée à une application fonctionnelle, sécurisée et personnalisée, en vous déchargeant de la complexité de la gestion du backend. L'environnement local Docker + CLI est là pour vous permettre de développer et tester tout cela efficacement avant de passer en production.

## Synthèse Finale (Révisée) : Débogage Authentification Supabase Local

### Problème Initial

Impossible d'enregistrer de nouveaux utilisateurs ("Sign Up") via l'interface Supabase Studio (`http://localhost:8000` initialement) avec l'erreur "Failed to create user: API error..." ou `403 Forbidden`. La connexion ("Login") des utilisateurs créés via l'admin échouait également initialement.

### Processus de Diagnostic et Solutions Apportées

1.  **Installation CLI Supabase :** Le système ne reconnaissait pas la commande `supabase`. Résolu en installant la CLI **localement** (`npm install supabase --save-dev`) et en utilisant **`npx supabase ...`** pour toutes les commandes futures dans ce projet.
2.  **Démarrage des Services :** Utilisation de `npx supabase start` pour lancer l'environnement Docker. Ceci a correctement démarré tous les services, y compris le service d'email manquant (`supabase-mail`/Inbucket). **Note :** Les URLs/ports par défaut ont changé (ex: API sur `127.0.0.1:54321`, Studio sur `127.0.0.1:54323`, Inbucket sur `127.0.0.1:54324`).
3.  **Erreur Signup via Studio :** Confirmé que Studio (accessible via Kong avec `DASHBOARD_USERNAME`/`PASSWORD` sur `http://127.0.0.1:54323`) appelle un endpoint admin (`/admin/users`) pour le signup, causant une erreur `403`. **Conclusion :** Studio n'est pas fait pour l'enregistrement public, utiliser les fonctions admin dédiées.
4.  **Vérification des JWTs (jwt.io) :** Identifié et résolu une désynchronisation des clés (`ANON_KEY`, `SERVICE_ROLE_KEY`) due à une mauvaise interprétation (Base64 vs littéral) du `JWT_SECRET` manuel. Regénération correcte des clés avec le secret littéral (option "secret base64 encoded" décochée sur jwt.io) et redémarrage via `npx`.
5.  **Problème Connexion DB (`broken pipe` / Erreur 500) :** Le service `supabase-auth` ne pouvait pas se connecter à `supabase-db` après certains redémarrages. Résolu par un arrêt/redémarrage propre via `npx supabase stop` / `npx supabase start`, permettant à la base de données de se stabiliser.
6.  **Création Utilisateur Admin :** Fonctionnelle via Studio (`Authentication -> Users -> Add user` ou `Invite user`).
7.  **Email d'Invitation Local (Inbucket) :**
    *   Compris que les emails en local ne sont pas envoyés à l'extérieur mais interceptés par **InBucket**, accessible via **`http://127.0.0.1:54324`**.
    *   **BUG LOCAL PERSISTANT :** Le **lien contenu dans l'email** d'invitation reçu dans Inbucket pointe **incorrectement vers `http://localhost:3000`** (port occupé par une autre application, potentiellement Open WebUI).
    *   **Cause Probable :** Mauvaise configuration de `SITE_URL` ou `API_EXTERNAL_URL` utilisée par GoTrue pour générer les liens.
    *   **Action Corrective Nécessaire (Local) :** Vérifier/Modifier les URLs dans `supabase/config.toml` (section `[auth]`, ex: `site_url`) ou les variables d'environnement passées au conteneur `supabase-auth` pour qu'elles correspondent à l'URL accessible par l'utilisateur pour finaliser l'invitation (probablement via le port Studio `54323` ou API `54321`). Puis `npx supabase stop` / `npx supabase start`.
8.  **Test Login Utilisateur (API) :** La connexion via API (`POST /auth/v1/token` sur `http://127.0.0.1:54321` avec email/mdp + `ANON_KEY`), testée avec PowerShell, est maintenant **fonctionnelle**.

### Statut Final (Local)

*   **Environnement Local :** Opérationnel via `npx supabase start` avec les URLs/ports standards (`54321`, `54323`, `54324`...).
*   **CLI Supabase :** Utilisable via `npx`.
*   **Accès Studio (Admin) :** OK via `http://127.0.0.1:54323` + identifiants Kong.
*   **Création Utilisateur (Admin) :** OK (`Add user` / `Invite user` via Studio).
*   **Réception Email Invitation :** OK (dans Inbucket sur `http://127.0.0.1:54324`).
*   **Lien Email Invitation :** **NON FONCTIONNEL (BUG)** - Pointe vers `localhost:3000`. Nécessite correction de config URL.
*   **Enregistrement Utilisateur (Public/Frontend) :** Possible via API (`supabase.auth.signUp()`) si activé. Non réalisable via Studio.
*   **Connexion Utilisateur (Frontend/API) :** Fonctionnelle via API (`supabase.auth.signInWithPassword()`).
*   **Observation Port 8000 :** Le port `8000` reste actif sur la machine. Son origine est incertaine (ancienne config Supabase avant `npx init`? Autre service du projet `local-ai-packaged`?). Cela n'impacte pas directement la stack Supabase actuelle (qui utilise `54321`/`54323`) mais pourrait être source de confusion.

### Prochaine Étape : Déploiement sur VPS Hostinger

(Les points clés restent les mêmes que dans la réponse précédente : préparation VPS, config Supabase pour production via self-hosting officiel, gestion des secrets, domaine/HTTPS, SMTP réel, ressources, tests...)

*Cette version inclut bien la vérification JWT, le bug du lien email sur le port 3000 et l'observation sur le port 8000. La correction du bug du lien email local devient une étape intermédiaire avant de passer sereinement à la production.*


 ## Résumé des Obstacles Franchis : Débogage Supabase Local (Point d'Étape)

Notre objectif était de rendre fonctionnel l'enregistrement et la connexion d'utilisateurs sur une instance Supabase locale, gérée via une configuration Docker Compose personnalisée. Voici les étapes et les obstacles surmontés :

### 1. Échec Initial d'Enregistrement "Public" via Studio

*   **Problème :** Tentative d'utiliser un formulaire "Sign Up" dans Supabase Studio (`http://localhost:8000` initialement) résultant en erreurs ("API error...", `403 Forbidden`).
*   **Diagnostic :** L'interface Studio appelait incorrectement l'endpoint admin (`/admin/users`) au lieu de l'endpoint public (`/signup`).
*   **Solution :** Comprendre que Studio est un outil *d'administration*. Utiliser les fonctions dédiées `Authentication -> Users -> Add user` ou `Invite user` pour créer des utilisateurs. L'enregistrement public doit se faire via l'API (`supabase.auth.signUp()`) depuis un frontend.

### 2. Désynchronisation JWT Secret & Clés API (Plusieurs Fois)

*   **Problème :** Échecs d'appels API (via PowerShell, puis via Studio pour `/invite`) avec des erreurs `403 Forbidden`, `invalid JWT`, `signature is invalid`.
*   **Diagnostic :** Incohérence entre le `JWT_SECRET` utilisé par le service `auth` (GoTrue) et celui utilisé pour signer les clés API (`ANON_KEY`, `SERVICE_ROLE_KEY`) fournies dans les requêtes ou dans la configuration. Problème initial lié à une confusion d'encodage Base64 vs littéral. Le problème est réapparu pour la `SERVICE_ROLE_KEY` plus tard.
*   **Solution :** Utiliser systématiquement le `JWT_SECRET` littéral (non encodé Base64). Vérifier la cohérence des 3 éléments (`JWT_SECRET`, `ANON_KEY`, `SERVICE_ROLE_KEY`) via jwt.io (case Base64 décochée). Regénérer les clés API si nécessaire en utilisant le `JWT_SECRET` actuel du `.env`. Redémarrer *complètement* la stack Docker après toute modification du `.env`.

### 3. Erreur 500 / Connexion Base de Données Échouée (`broken pipe`)

*   **Problème :** Les tentatives de connexion utilisateur via l'API (`/token`) échouaient avec une erreur `500 Internal Server Error`.
*   **Diagnostic :** Les logs de `supabase-auth` montraient une erreur "broken pipe". Les logs de `supabase-db` (Postgres) indiquaient que la base de données n'acceptait pas les connexions à certains moments (probablement pendant ou après un démarrage instable).
*   **Solution :** Assurer un arrêt propre (`docker compose ... down`) et un redémarrage complet (`python start_services.py ...`) de l'ensemble de la stack Docker, en laissant le temps à la base de données de s'initialiser correctement.

### 4. Confusion : Authentification Kong vs Authentification Utilisateur Supabase

*   **Problème :** Affichage de "Kong Error: Invalid authentication credentials" lors de l'accès à l'interface Studio (`http://localhost:8000`).
*   **Diagnostic :** Tentative d'utiliser les identifiants (email/mot de passe) d'un *utilisateur Supabase final* pour passer l'authentification basique mise en place par Kong devant Studio.
*   **Solution :** Clarifier les deux niveaux :
    *   **Kong (Accès Studio) :** Utilise `DASHBOARD_USERNAME` / `DASHBOARD_PASSWORD` définis dans le `.env` et demandés par une pop-up du navigateur.
    *   **Supabase Auth (Utilisateurs Finaux) :** Utilise l'email/mot de passe de l'utilisateur + `ANON_KEY` via les appels API (`/token`, `/signup`, etc.) depuis une application frontend.

### 5. CLI Supabase (`supabase`) Non Reconnue

*   **Problème :** La commande `supabase start` (ou autre) échouait avec "Le terme «supabase» n'est pas reconnu...".
*   **Diagnostic :** L'outil CLI Supabase n'était pas installé globalement ou son chemin d'installation n'était pas dans le `PATH` système. Confusion initiale car les *services* Supabase tournent sur Docker, mais la *CLI* est un outil hôte.
*   **Solution :** Installer la CLI Supabase *localement* dans le projet (`npm install supabase --save-dev`) et utiliser systématiquement `npx supabase ...` pour exécuter les commandes CLI dans ce contexte. **NOTE :** Cette approche a été abandonnée par la suite au profit de la gestion exclusive via Docker Compose.

### 6. Découverte de Deux Stacks Supabase Conflictuelles

*   **Problème :** Les configurations semblaient ne pas être prises en compte, `npx supabase stop` n'arrêtait pas les services visibles.
*   **Diagnostic :** La commande `docker ps` a révélé deux ensembles complets de conteneurs Supabase tournant simultanément : un lancé via `npx supabase start` (utilisant `config.toml` et des ports comme 5432x) et un autre lancé via `python start_services.py` et `docker-compose` (utilisant `.env` et des ports comme 8000).
*   **Solution :** Standardiser sur **UNE SEULE** méthode : celle de `docker-compose` pilotée par `python start_services.py`. Arrêter *tous* les conteneurs Supabase des deux stacks (`docker compose down ...` ET `docker stop ...` pour les anciens conteneurs `npx`), nettoyer (`docker container prune`), et n'utiliser que la méthode `docker compose` pour démarrer/arrêter. Ignorer `config.toml` pour la configuration d'exécution ; utiliser le `.env` lu par `docker-compose`.

### 7. Service Email Local (Mailpit/Inbucket) Manquant

*   **Problème :** Les emails d'invitation n'étaient pas reçus/visibles localement, même après avoir corrigé les problèmes JWT.
*   **Diagnostic :** La commande `docker ps` (après nettoyage des stacks) a montré qu'aucun conteneur `mailpit`, `inbucket`, ou `supabase-mail` n'était démarré par la configuration `docker-compose`.
*   **Solution :** **Ajouter** la définition du service `mailpit` dans le fichier `supabase/docker/docker-compose.yml`. Configurer les variables d'environnement SMTP (`SMTP_HOST=mailpit`, `SMTP_PORT=1025`, etc.) dans le fichier `.env` pour que `supabase-auth` puisse communiquer avec le service `mailpit`. Redémarrer la stack complète.

### 8. Lien Email Incorrect (Port 3000/8000 au lieu de 64663)

*   **Problème :** Le lien d'invitation dans l'email (une fois Mailpit ajouté) pointait vers le mauvais port (`3000` ou `8000`) au lieu du port du serveur frontend (`64663`).
*   **Diagnostic :** La variable d'environnement `SITE_URL` dans le fichier `.env` (lue par `docker compose` et passée à `GOTRUE_SITE_URL`) avait une valeur incorrecte.
*   **Solution :** Modifier la variable `SITE_URL` dans le fichier `.env` pour qu'elle corresponde à l'URL et au port exacts du serveur frontend (`http://localhost:64663`). Redémarrer la stack complète.

### 9. Erreur d'Initialisation du Frontend (`index.html`)

*   **Problème :** La page frontend minimale (`index.html` servie sur `http://localhost:64663`) affichait "Erreur lors de l'initialisation du client Supabase...".
*   **Diagnostic :** Les constantes `SUPABASE_URL` ou `SUPABASE_ANON_KEY` dans le code Javascript de `index.html` étaient incorrectes pour la stack Docker Compose active. Elles utilisaient peut-être une mauvaise URL API (port `54321`) ou une clé Anon invalide/désynchronisée.
*   **Solution :** Mettre à jour `index.html` pour utiliser l'URL API correcte exposée par Kong (`SUPABASE_URL = 'http://localhost:8000'`) et la `SUPABASE_ANON_KEY` correspondant exactement à la valeur `ANON_KEY` dans le fichier `.env` utilisé par la stack Docker Compose.

---

### Point Actuel: ERR_CONNECTION_REFUSED

*   **État :**
    *   La stack Docker Compose (incluant `mailpit`) est démarrée proprement et seule.
    *   Le serveur frontend (`serve`) tourne sur `http://localhost:64663`.
    *   Le fichier `.env` est configuré avec `SITE_URL=http://localhost:64663` et les bonnes clés/secrets (vérifiés).
    *   `index.html` est configuré avec l'API sur `http://localhost:8000` et la bonne clé Anon. L'accès direct à `http://localhost:64663` ne montre plus d'erreur d'initialisation.
    *   L'invitation depuis Studio réussit (status 200 pour `/invite` dans les logs `supabase-auth`).
    *   L'email est reçu dans Mailpit (`http://localhost:54324`).
    *   Le lien dans l'email **pointe (normalement) vers `http://localhost:64663/...`**.
*   **NOUVEAU PROBLÈME :** Cliquer sur ce lien dans l'email reçu dans Mailpit aboutit à une erreur `ERR_CONNECTION_REFUSED` dans le navigateur pour l'adresse `http://localhost:64663`.
*   **Hypothèses Actuelles :**
    *   Le serveur `serve` sur `64663` s'est arrêté ou a crashé entre-temps ?
    *   Le lien contient-il une erreur subtile *malgré tout* (par exemple, `http://127.0.0.1:64663` vs `http://localhost:64663`) ?
    *   Problème de cache navigateur ou de redirection inattendue ?
    *   Configuration du pare-feu local bloquant l'accès ? (Peu probable si l'accès direct fonctionnait).

Nous sommes à un cheveu du succès. Il faut comprendre pourquoi le navigateur ne parvient pas à se connecter à `localhost:64663` *uniquement* lorsqu'on clique sur le lien, alors que l'accès direct fonctionne et que le serveur `serve` est censé tourner.
## Issue Analysis and Solution

### The Problem
The original code failed to initialize the Supabase client due to **script loading sequence issues**. Specifically:

1. Using `defer` on both scripts created a race condition
2. The Supabase library wasn't fully loaded when your code tried to use it
3. Error handling was insufficient to diagnose the problem

### The Solution
Fixed by implementing a proper loading sequence:

1. **Loading the library first**: Removed `defer` attribute to ensure Supabase loads completely
2. **Initialization timing**: Used `window.addEventListener('load', ...)` to guarantee correct sequence
3. **Comprehensive error handling**: Added detailed logging and visual feedback
4. **Direct testing**: Implemented test buttons to verify specific services (Auth/API)

### Technical details
- Script race conditions are common when libraries must be fully initialized before use
- Local Supabase requires proper connectivity to multiple services (Kong, Auth, PostgreSQL)
- The error "_dummy_query_ does not exist" confirms successful database connectivity

# Logbook : Configuration SMTP Supabase sur VDS (Hostinger)

**Objectif :** Activer l'envoi d'emails réels (invitation, confirmation, etc.) depuis l'instance Supabase self-hosted sur le VDS (`supabase.atthesametime.eu`) en utilisant un compte email Hostinger.

**Étapes Réalisées :**

1.  **Identification Fournisseur SMTP :**
    *   Le fournisseur SMTP utilisé sera Hostinger, associé au compte email fonctionnel `jp.brasile@atthesametime.eu`.

2.  **Récupération Paramètres SMTP Hostinger :**
    *   Les paramètres serveur ont été identifiés via l'interface hPanel Hostinger :
        *   Serveur sortant (Host) : `smtp.hostinger.com`
        *   Port : `465` (avec SSL/TLS)

3.  **Modification du Fichier `.env` sur VDS :**
    *   **URLs Publiques :**
        *   `API_EXTERNAL_URL` corrigée pour pointer vers l'URL publique : `https://supabase.atthesametime.eu`.
        *   `SITE_URL` corrigée pour pointer vers l'URL **réelle** du frontend où l'utilisateur finalise l'action (ex: `https://VOTRE_URL_FRONTEND_REELLE`). *Note : Doit être l'URL accessible par l'utilisateur.*
    *   **Configuration Email (`[auth]` section) :**
        *   `ENABLE_EMAIL_AUTOCONFIRM` mis à `false` (**CRUCIAL** pour la production, nécessite confirmation par clic).
        *   `SMTP_HOST` mis à `smtp.hostinger.com`.
        *   `SMTP_PORT` mis à `465`.
        *   `SMTP_USER` mis à `jp.brasile@atthesametime.eu`.
        *   `SMTP_PASS` mis à le mot de passe **spécifique** du compte email `jp.brasile@atthesametime.eu`. (Utilisé `********` dans le log pour sécurité).
        *   `SMTP_SENDER_NAME` défini à un nom d'expéditeur approprié (ex: "Votre Application").
        *   Les anciennes valeurs "fake" ou liées à Mailpit/supabase-mail ont été remplacées.

4.  **Mise à Jour Fichier `.env` :**
    *   Le contenu du fichier `.env` sur le VDS a été remplacé par la nouvelle configuration (via `cat > .env` ou `nano`). Une sauvegarde (`.env.bak`) a été potentiellement créée.

5.  **Redémarrage Stack Supabase :**
    *   Les conteneurs Docker Supabase ont été redémarrés pour prendre en compte les nouvelles variables d'environnement :
        ```bash
        docker compose down
        docker compose up -d
        ```

**État Actuel :**

*   La stack Supabase sur le VDS est en cours d'exécution avec la configuration SMTP pointant vers les serveurs Hostinger en utilisant les identifiants de `jp.brasile@atthesametime.eu`.
*   `ENABLE_EMAIL_AUTOCONFIRM` est désactivé, forçant la validation par email.

**Prochaines Étapes Recommandées :**

1.  **Tester l'envoi d'email :** Inviter un nouvel utilisateur (email externe réel) via Supabase Studio et vérifier la réception.
2.  **Vérifier la Déliverabilité :** Si les emails n'arrivent pas ou vont en spam, vérifier la configuration **DNS (SPF, DKIM)** pour le domaine `atthesametime.eu` chez Hostinger.

# Logbook : Difficultés d'Implantation Backend - Supabase Self-Hosted sur VDS

**Objectif Initial :** Configurer l'envoi d'emails via SMTP (Hostinger) pour une instance Supabase self-hosted.

**Environnement :**
*   VDS Hostinger
*   Stack Docker gérée via `docker compose` (lancée depuis `~/local-ai-packaged/`)
*   Supabase auto-hébergé (incluant Supavisor, GoTrue, Realtime, etc.)
*   Caddy comme reverse proxy.
*   Fichier `.env` principal utilisé : `~/local-ai-packaged/.env`

**Difficultés d'Implantation Backend Rencontrées :**

1.  **Instabilité de `supabase-pooler` (Service `supavisor`)**
    *   **Symptôme :** Conteneur `supabase-pooler` redémarrait en boucle (`Restarting`).
    *   **Investigation :** Analyse des logs (`docker logs <ID_pooler>`).
    *   **Cause Racine Identifiée :** Erreur cryptographique `(ErlangError) Erlang error: {:badarg, {~c"aead.c", 90}, ~c"Unknown cipher or invalid key size"}` lors de l'appel à `:crypto.crypto_one_time_aead`. La clé utilisée était initialement un placeholder (`"your-encryption-key-32-chars-exactly"`) puis une clé hexadécimale de 64 caractères (`"6bbcfa..."`), toutes deux considérées comme invalides par la librairie pour `aes_256_gcm` dans ce contexte. La variable d'environnement lue par Supavisor dans cette configuration était `VAULT_ENC_KEY`. Confusion initiale entre `VAULT_ENC_KEY` et `PGBOUNCER_ENCRYPTION_KEY`.
    *   **Résolution :** Remplacement de la valeur de `VAULT_ENC_KEY` dans le fichier `~/local-ai-packaged/.env` par une clé **hexadécimale de 32 caractères** (générée via `openssl rand -hex 16`), suivie d'un redémarrage de la stack (`docker compose down && docker compose up -d`).

2.  **Instabilité de `supabase-auth` (Service `auth`)**
    *   **Symptôme :** Après stabilisation du pooler, le conteneur `supabase-auth` a commencé à redémarrer en boucle.
    *   **Investigation :** Analyse des logs (`docker logs <ID_auth>`).
    *   **Cause Racine Identifiée :** Erreur fatale au démarrage : `Failed to load configuration: envconfig.Process: assigning GOTRUE_EXTERNAL_ANONYMOUS_USERS_ENABLED to Enabled: converting '' to type bool. details: strconv.ParseBool: parsing \"\": invalid syntax`. La variable d'environnement `ENABLE_ANONYMOUS_USERS` était manquante ou vide dans le fichier `.env`, et GoTrue ne pouvait pas la convertir en booléen (`true`/`false`).
    *   **Résolution :** Ajout explicite de la ligne `ENABLE_ANONYMOUS_USERS=false` dans le fichier `~/local-ai-packaged/.env`, suivie d'un redémarrage de la stack.

3.  **Statut `unhealthy` de `realtime-dev.supabase-realtime` (Service `realtime`)**
    *   **Symptôme :** Même avec le pooler et auth stables, le conteneur `realtime` restait `unhealthy`.
    *   **Investigation :** Analyse des logs (`docker logs <ID_realtime>`). Les logs montraient des requêtes répétées vers `/api/tenants/realtime-dev/health` recevant une réponse `403 Forbidden`. Vérification de la définition du `healthcheck` dans `~/local-ai-packaged/supabase/docker/docker-compose.yml` qui utilise `${ANON_KEY}` pour l'authentification.
    *   **Cause Racine Identifiée :** La valeur de la variable `ANON_KEY` dans le fichier `~/local-ai-packaged/.env` était incomplète ou incorrecte, probablement suite à une erreur de copier-coller depuis la documentation (clé multiligne mal copiée). Le token Bearer envoyé par le health check était donc invalide.
    *   **Résolution :** Correction de la valeur de `ANON_KEY` dans `~/local-ai-packaged/.env` en s'assurant que la clé complète et exacte (provenant de la documentation ou de la génération) était présente. Redémarrage de la stack.

4.  **Confusion sur le Fichier `.env` Utilisé**
    *   **Symptôme :** Les modifications apportées initialement au fichier `.env` dans `~/supabase/docker/` ne semblaient pas prises en compte.
    *   **Investigation :** Clarification du workflow de démarrage : `docker compose` était lancé depuis le répertoire parent `~/local-ai-packaged/`.
    *   **Cause Racine Identifiée :** Docker Compose, lancé depuis `~/local-ai-packaged/`, lit par défaut le fichier `~/local-ai-packaged/.env`, et non `~/supabase/docker/.env`. L'écrasement initial du fichier `.env` principal avec le contenu de Supabase a permis (par chance) de faire fonctionner les corrections ultérieures via ce fichier principal.
    *   **Résolution (Conceptuelle) :** Compréhension que toutes les variables d'environnement pertinentes pour la stack Docker doivent être gérées dans le fichier `.env` du répertoire à partir duquel `docker compose` est exécuté (`~/local-ai-packaged/.env` dans ce cas). Il est recommandé de maintenir la cohérence dans `~/supabase/docker/.env` pour des lancements isolés potentiels.

**État Final du Backend :**
*   Tous les conteneurs de la stack Supabase (pooler, auth, realtime, db, kong, etc.) sont stables et passent leurs health checks (`Up (healthy)`).
*   La configuration SMTP pour l'envoi d'emails via Hostinger est fonctionnelle (vérifié par l'envoi réussi d'un email de réinitialisation de mot de passe).
*   Le backend redirige correctement vers la `SITE_URL` (`https://app.atthesametime.eu`) après les actions d'authentification.

**Prochaines Étapes (Hors Scope de ce Log des Difficultés Backend) :**
*   Développement/adaptation du frontend (`app.atthesametime.eu`) pour gérer correctement les retours d'authentification (ex: afficher un formulaire de réinitialisation de mot de passe lors de la réception de `type=recovery`).
*   Sécurisation finale : Remplacement des clés par défaut (`ANON_KEY`, `SERVICE_ROLE_KEY`), renforcement des mots de passe (`POSTGRES_PASSWORD`, `DASHBOARD_PASSWORD`, SMTP, etc.).
*   Configuration DNS (SPF, DKIM, DMARC) pour améliorer la déliverabilité des emails.
